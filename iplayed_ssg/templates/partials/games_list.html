{%- set games_list = games | default(value=[]) -%}
{%- set search_enabled = enable_search | default(value=false) -%}
{%- set show_search = search_enabled and games_list | length > 0 -%}

{% if show_search %}
<section class="games-search" aria-label="Filter games">
    <label class="games-search__label" for="games-search-input">Search the archive</label>
    <input id="games-search-input" class="games-search__input" type="search" name="query"
        placeholder="Type a title, platform, or genreâ€¦" autocomplete="off" data-games-search-input>
    <p class="games-search__status" data-games-search-status aria-live="polite">
        Showing {{ games_list | length }} games
    </p>
</section>
{% endif %}

<div class="games-listing" data-games-list>
    {% for page in games_list -%}
    {%- set completed = page.extra.completed_at | default(value=page.date) -%}
    {%- set subtitle = page.extra.subtitle | default(value=page.description | default(value="")) -%}
    {%- set playtime = page.extra.playtime | default(value="") -%}
    {%- set platforms = page.taxonomies.platforms | default(value=[]) -%}
    {%- set genres = page.taxonomies.genres | default(value=[]) -%}
    {%- set rating_values = page.taxonomies.rating | default(value=[]) -%}
    {%- set search_context = [page.title, subtitle, playtime, platforms | join(sep=" "), genres | join(sep=" "), rating_values | join(sep=" "), completed] | join(sep=" ") -%}
    <div class="game-card" data-game-card data-search-text="{{ search_context | lower | escape }}">
        <div class="game-container">
            {%- if page.extra.url_cover_small -%}
            <div class="game-entry__image">
                <img src="{{ page.extra.url_cover_big | safe }}" alt="{{ page.title | safe }}">
            </div>
            {%- endif -%}
            <article class="post game-entry__content">
                <h2 class="post-title">
                    <a href="{{ page.permalink | safe }}">{{ page.title }}</a>
                </h2>
                <div class="game-entry__meta">
                    {% if playtime %}
                    <span class="game-entry__badge">
                        <span class="game-entry__badge-label">Playtime</span>
                        <span class="game-entry__badge-value">{{ playtime }}</span>
                    </span>
                    {% endif %}
                    {% if rating_values | length > 0 %}
                    {% set rating_raw = rating_values | first %}
                    {% set rating_value = rating_raw | float %}
                    {% set rating_display = rating_raw | trim_end_matches(pat=".0") %}
                    {% set rating_percent = (rating_value / 10.0 * 100.0) %}
                    <span class="game-entry__badge">
                        <span class="game-entry__badge-label">Rating</span>
                        <span class="game-entry__badge-value">{{ rating_display }}/10</span>
                        <span class="game-entry__badge-scale" role="img" aria-label="Rating {{ rating_display }} of 10">
                            <span style="width: {{ rating_percent }}%;"></span>
                        </span>
                    </span>
                    {% endif %}
                    {% if platforms %}
                    <span class="game-entry__badge game-entry__badge--chips">
                        <span class="game-entry__badge-label">Platforms</span>
                        <span class="game-entry__badge-value">
                            {% for platform in platforms %}
                            {% set platform_url = get_taxonomy_url(kind="platforms", name=platform, lang=page.lang) %}
                            <a class="terminal-chip" rel="tag" href="{{ platform_url | safe }}">{{ platform }}</a>
                            <!-- <span class="game-entry__chip">{{ platform }}</span> -->
                            {% endfor %}
                        </span>
                    </span>
                    {% endif %}
                </div>
            </article>
        </div>
    </div>
    {% endfor -%}
</div>

{% if show_search %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const input = document.querySelector('[data-games-search-input]');
        const status = document.querySelector('[data-games-search-status]');
        const cards = Array.from(document.querySelectorAll('[data-game-card]'));

        if (!input || !status || cards.length === 0) {
            return;
        }

        const total = cards.length;

        function update() {
            const query = input.value.trim().toLowerCase();
            let visible = 0;

            cards.forEach((card) => {
                const haystack = card.dataset.searchText || card.textContent.toLowerCase();
                const matches = !query || haystack.includes(query);
                card.hidden = !matches;
                if (matches) {
                    visible += 1;
                }
            });

            const suffix = query ? ` for "${query}"` : '';
            status.textContent = `Showing ${visible} of ${total} games${suffix}`;
        }

        input.addEventListener('input', update);
    });
</script>
{% endif %}
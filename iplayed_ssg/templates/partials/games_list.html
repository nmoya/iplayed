{%- set games_list = games | default(value=[]) -%}
{%- set search_enabled = enable_search | default(value=false) -%}
{%- set show_search = search_enabled and games_list | length > 0 -%}

{% if show_search %}
<section class="games-search" aria-label="Filter games">
    <label class="games-search__label" for="games-search-input">Search the archive</label>
    <input id="games-search-input" class="games-search__input" type="search" name="query"
        placeholder="Type a title, platform, or genre&hellip;" autocomplete="off" data-games-search-input>

    <div class="games-search__filters">
        <div class="games-search__filter">
            <label class="games-search__filter-label" for="games-rating-filter">Rating filter</label>
            {%- set rating_options = [10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0] -%}
            <div id="games-rating-filter" class="games-search__checkboxes" data-games-rating-checkboxes>
                {% for score in rating_options %}
                <label class="games-search__checkbox">
                    <input type="checkbox" value="{{ score }}" data-rating-filter-checkbox>
                    <span>{{ score }}/10</span>
                </label>
                {% endfor %}
            </div>
            <p class="games-search__help">Select one or more ratings to narrow down the list.</p>
        </div>
    </div>

    <p class="games-search__status" data-games-search-status aria-live="polite">
        Showing {{ games_list | length }} games
    </p>
</section>
{% endif %}

<div class="games-listing" data-games-list>
    {% for page in games_list -%}
    {%- set completed = page.extra.completed_at | default(value=page.date) -%}
    {%- set subtitle = page.extra.subtitle | default(value=page.description | default(value="")) -%}
    {%- set playtime = page.extra.playtime | default(value="") -%}
    {%- set platforms = page.taxonomies.platforms | default(value=[]) -%}
    {%- set genres = page.taxonomies.genres | default(value=[]) -%}
    {%- set rating_values = page.taxonomies.rating | default(value=[]) -%}
    {%- set has_rating = rating_values | length > 0 -%}
    {%- if has_rating -%}
    {%- set rating_raw = rating_values | first -%}
    {%- set rating_value = rating_raw | float -%}
    {%- set rating_display = rating_raw | trim_end_matches(pat=".0") -%}
    {%- set rating_percent = (rating_value / 10.0 * 100.0) -%}
    {%- set rating_int = rating_value | int -%}
    {%- else -%}
    {%- set rating_raw = "" -%}
    {%- set rating_value = 0 -%}
    {%- set rating_display = "" -%}
    {%- set rating_percent = 0 -%}
    {%- set rating_int = "" -%}
    {%- endif -%}
    {%- set search_context = [page.title, subtitle, playtime, platforms | join(sep=" "), genres | join(sep=" "), rating_values | join(sep=" "), completed] | join(sep=" ") -%}
    <div class="game-card" data-game-card data-search-text="{{ search_context | lower | escape }}"
        data-rating="{{ rating_int }}">
        <div class="game-container">
            {%- if page.extra.url_cover_small -%}
            <div class="game-entry__image">
                <img src="{{ page.extra.url_cover_big | safe }}" alt="{{ page.title | safe }}">
            </div>
            {%- endif -%}
            <article class="post game-entry__content">
                <h2 class="post-title">
                    <a href="{{ page.permalink | safe }}">{{ page.title }}</a>
                </h2>
                <div class="game-entry__meta">
                    {% if playtime %}
                    <span class="game-entry__badge">
                        <span class="game-entry__badge-label">Playtime</span>
                        <span class="game-entry__badge-value">{{ playtime }}</span>
                    </span>
                    {% endif %}
                    {% if has_rating %}
                    <span class="game-entry__badge">
                        <span class="game-entry__badge-label">Rating</span>
                        <span class="game-entry__badge-value">{{ rating_display }}/10</span>
                        <span class="game-entry__badge-scale" role="img" aria-label="Rating {{ rating_display }} of 10">
                            <span style="width: {{ rating_percent }}%;"></span>
                        </span>
                    </span>
                    {% endif %}
                    {% if platforms %}
                    <span class="game-entry__badge game-entry__badge--chips">
                        <span class="game-entry__badge-label">Platforms</span>
                        <span class="game-entry__badge-value">
                            {% for platform in platforms %}
                            {% set platform_url = get_taxonomy_url(kind="platforms", name=platform, lang=page.lang) %}
                            <a class="terminal-chip" rel="tag" href="{{ platform_url | safe }}">{{ platform }}</a>
                            {% endfor %}
                        </span>
                    </span>
                    {% endif %}
                </div>
            </article>
        </div>
    </div>
    {% endfor -%}
</div>

{% if show_search %}
<script src="{{ get_url(path="js/games-search.js", cachebust=true) }}" defer></script>
{% endif %}
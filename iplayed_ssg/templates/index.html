{% extends "base.html" %}

{%- block title -%}
{{ section.title | default(value="Home") }} | {{ config.title }}
{%- endblock -%}

{%- block description -%}
{%- if section.description %}
<meta name="description" content="{{ section.description | markdown(inline=true) | striptags | safe }}">
{%- endif -%}
{%- endblock -%}

{%- block main -%}
{%- filter indent -%}{%- filter indent -%}
<section class="stats content">
    {% if section.content %}
    {{ section.content | markdown | safe }}
    {% endif %}

    <div class="stats-dashboard">

        <article class="stats-card stats-card--highlight">
            <header>
                <h2>Hours Played</h2>
            </header>
            <p id="hoursPlayedDisplay" class="stats-total" aria-live="polite">Loading</p>
            <p id="hoursPlayedSubheading" class="stats-total__caption"></p>
        </article>
        <article class="stats-card">
            <header>
                <h2>Recent Completions</h2>
            </header>
            <div id="recentCompletions" class="stats-list" aria-live="polite"></div>
        </article>


        <article class="stats-card">
            <header class="stats-card__header">
                <div>
                    <h2>Completions per Month</h2>
                    <p class="stats-card__subtitle">Tap a month to see the games you wrapped up.</p>
                </div>
                <div id="year-tabs" class="stats-tabs" role="tablist" aria-label="Years"></div>
            </header>
            <div id="monthly-heatmap" class="stats-heatmap" role="grid" aria-live="polite"></div>
            <div id="month-detail" class="stats-heatmap__detail" aria-live="polite">
                Select a month to view completions.
            </div>
        </article>

        <article class="stats-card">
            <header>
                <h2>Completions per Platform</h2>
            </header>
            <canvas id="platformHistogram" width="420" height="320" aria-label="Completions per platform"></canvas>
            <a href="{{ get_url(path='platforms') }}" class="stats-link">Browse platforms</a>
        </article>

        <article class="stats-card">
            <header>
                <h2>Genre Mix</h2>
                <p class="stats-card__subtitle">Games completed vs. hours invested.</p>
            </header>
            <canvas id="genreComparison" width="420" height="320" aria-label="Genre completion comparison"></canvas>
        </article>

        <article class="stats-card">
            <header>
                <h2>Top Played Game by Genre</h2>
            </header>
            <div id="topGamesByGenre" class="stats-list" aria-live="polite"></div>
            <a href="{{ get_url(path='genres') }}" class="stats-link">Explore genres</a>
        </article>
    </div>
</section>
{% endfilter %}{% endfilter %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        const els = {
            total: document.getElementById('hoursPlayedDisplay'),
            totalCaption: document.getElementById('hoursPlayedSubheading'),
            tabs: document.getElementById('year-tabs'),
            heatmap: document.getElementById('monthly-heatmap'),
            monthDetail: document.getElementById('month-detail'),
            platformCanvas: document.getElementById('platformHistogram'),
            genreCanvas: document.getElementById('genreComparison'),
            topList: document.getElementById('topGamesByGenre'),
            recentList: document.getElementById('recentCompletions')
        };

        const charts = {};
        const gamesBaseUrl = "{{ get_url(path='games', trailing_slash=true) | safe }}";

        const rootStyles = getComputedStyle(document.documentElement);
        const themeColors = {
            text: rootStyles.getPropertyValue('--text-color').trim() || '#ffffff',
            accent: rootStyles.getPropertyValue('--accent-color').trim() || '#ffa86a',
            accentSoft: 'rgba(255, 168, 106, 0.6)',
            highlight: 'rgba(255, 153, 102, 0.9)',
            grid: 'rgba(255, 255, 255, 0.12)',
            tooltipBg: 'rgba(0, 0, 0, 0.85)'
        };

        if (window.Chart) {
            Chart.defaults.color = themeColors.text;
            Chart.defaults.font.family = '"Fira Code", Monaco, Consolas, "Ubuntu Mono", monospace';
            Chart.defaults.font.size = 12;
            Chart.defaults.plugins.tooltip.backgroundColor = themeColors.tooltipBg;
            Chart.defaults.plugins.tooltip.titleColor = themeColors.text;
            Chart.defaults.plugins.tooltip.bodyColor = themeColors.text;
        }

        const numberFormatter = new Intl.NumberFormat('en-US', { maximumFractionDigits: 1 });

        function formatHours(value) {
            return `${numberFormatter.format(value)} h`;
        }

        function updateTotals(totalHours, totalGames) {
            els.total.textContent = formatHours(totalHours);
            const gamesLabel = totalGames === 1 ? 'game' : 'games';
            els.totalCaption.textContent = `Across ${totalGames} completed ${gamesLabel}`;
        }

        function updateMonthDetail(year, monthIndex, games) {
            const heading = `<strong>${monthNames[monthIndex]} ${year}</strong>`;
            if (!games.length) {
                els.monthDetail.innerHTML = `${heading}: no completions logged.`;
                return;
            }
            const list = games.map(game => `<li>${game.name}</li>`).join('');
            els.monthDetail.innerHTML = `
      ${heading}
      <ul class="stats-mini-list">
        ${list}
      </ul>
    `;
        }

        function renderHeatmap(year, months) {
            els.heatmap.innerHTML = '';
            const monthIndexes = Array.from({ length: 12 }, (_, index) => index);
            const maxCount = Math.max(1, ...monthIndexes.map(idx => (months[idx] || []).length));
            let activeCell = null;

            monthIndexes.forEach((index) => {
                const games = months[index] || [];
                const value = games.length;
                const cell = document.createElement('button');
                cell.type = 'button';
                cell.className = 'stats-heatmap__cell';
                cell.dataset.count = value;
                cell.innerHTML = `
        <span class="stats-heatmap__month">${monthNames[index]}</span>
        <span class="stats-heatmap__value">${value}</span>
      `;
                const alpha = 0.08 + (value / maxCount) * 0.92;
                cell.style.setProperty('--stats-heat-alpha', `${(alpha * 100).toFixed(0)}%`);

                cell.addEventListener('click', () => {
                    if (activeCell) {
                        activeCell.classList.remove('is-active');
                    }
                    cell.classList.add('is-active');
                    activeCell = cell;
                    updateMonthDetail(year, index, games);
                });
                els.heatmap.appendChild(cell);
            });

            const defaultIndex = monthIndexes.find((idx) => (months[idx] || []).length) ?? monthIndexes[monthIndexes.length - 1];
            const defaultCell = els.heatmap.children[defaultIndex];
            if (defaultCell instanceof HTMLElement) {
                defaultCell.classList.add('is-active');
                activeCell = defaultCell;
            }
            updateMonthDetail(year, defaultIndex, months[defaultIndex] || []);
        }

        function renderYearTabs(gamesByYearMonth) {
            els.tabs.innerHTML = '';
            const years = Object.keys(gamesByYearMonth).sort();
            if (!years.length) {
                els.monthDetail.textContent = 'No completion data available yet.';
                return;
            }

            const latestYear = years[years.length - 1];
            years.forEach((year) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'stats-tab';
                button.textContent = year;
                button.setAttribute('role', 'tab');
                button.setAttribute('aria-selected', year === latestYear ? 'true' : 'false');
                button.addEventListener('click', () => {
                    [...els.tabs.children].forEach(tab => tab.setAttribute('aria-selected', 'false'));
                    button.setAttribute('aria-selected', 'true');
                    renderHeatmap(year, gamesByYearMonth[year]);
                });
                els.tabs.appendChild(button);
            });

            renderHeatmap(latestYear, gamesByYearMonth[latestYear]);
        }

        function renderPlatformHistogram(platformCounts) {
            if (!els.platformCanvas) {
                return;
            }
            const entries = Object.entries(platformCounts);
            if (!entries.length) {
                els.platformCanvas.replaceWith(createEmptyState('platform data'));
                return;
            }
            const labels = entries.map(([platform]) => platform);
            const data = entries.map(([, count]) => count);

            charts.platform = new Chart(els.platformCanvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Completions',
                        data,
                        backgroundColor: themeColors.accentSoft,
                        borderColor: themeColors.accent,
                        borderWidth: 1.5,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { color: themeColors.text },
                            grid: { color: themeColors.grid, drawBorder: false }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: themeColors.text },
                            grid: { color: themeColors.grid, drawBorder: false }
                        }
                    }
                }
            });
        }

        function renderGenreComparison(genreCounts, genreHours) {
            if (!els.genreCanvas) {
                return;
            }
            const genres = Array.from(new Set([
                ...Object.keys(genreCounts),
                ...Object.keys(genreHours)
            ]));
            if (!genres.length) {
                els.genreCanvas.replaceWith(createEmptyState('genre breakdowns'));
                return;
            }
            const counts = genres.map((genre) => genreCounts[genre] || 0);
            const hours = genres.map((genre) => genreHours[genre] || 0);

            charts.genre = new Chart(els.genreCanvas, {
                type: 'bar',
                data: {
                    labels: genres,
                    datasets: [
                        {
                            label: 'Completions',
                            data: counts,
                            backgroundColor: themeColors.accentSoft,
                            borderColor: themeColors.accent,
                            borderWidth: 1.5,
                            borderRadius: 4
                        },
                        {
                            label: 'Hours',
                            data: hours,
                            backgroundColor: themeColors.highlight,
                            borderColor: themeColors.highlight,
                            borderWidth: 1.5,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            ticks: { color: themeColors.text },
                            grid: { color: themeColors.grid, drawBorder: false }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: themeColors.text },
                            grid: { color: themeColors.grid, drawBorder: false }
                        }
                    }
                }
            });
        }

        function renderRecentCompletions(entries) {
            if (!els.recentList) {
                return;
            }
            els.recentList.innerHTML = '';
            if (!entries.length) {
                els.recentList.innerHTML = '<p class="stats-empty">No recent completions logged.</p>';
                return;
            }

            entries.forEach((entry) => {
                const row = document.createElement('div');
                row.className = 'stats-list__item';

                const dateEl = document.createElement('span');
                dateEl.className = 'stats-list__date';
                dateEl.textContent = entry.displayDate;

                const gameEl = document.createElement('strong');
                gameEl.className = 'stats-list__game';
                const link = document.createElement('a');
                if (entry.permalink) {
                    link.href = entry.permalink;
                } else {
                    link.setAttribute('aria-disabled', 'true');
                    link.href = 'javascript:void(0)';
                }
                link.textContent = entry.name;
                link.className = 'stats-list__game-link';
                gameEl.appendChild(link);

                row.append(dateEl, gameEl);
                els.recentList.appendChild(row);
            });
        }

        function renderTopGames(topGamesByGenre) {
            if (!els.topList) {
                return;
            }
            els.topList.innerHTML = '';
            const entries = Object.entries(topGamesByGenre).sort(([a], [b]) => a.localeCompare(b));
            if (!entries.length) {
                els.topList.innerHTML = '<p class="stats-empty">No genre data yet.</p>';
                return;
            }
            entries.forEach(([genre, info]) => {
                const row = document.createElement('div');
                row.className = 'stats-list__item';

                const genreEl = document.createElement('span');
                genreEl.className = 'stats-list__genre';
                genreEl.textContent = genre;

                const gameEl = document.createElement('strong');
                gameEl.className = 'stats-list__game';
                const link = document.createElement('a');
                link.className = 'stats-list__game-link';
                if (info.permalink) {
                    link.href = info.permalink;
                } else {
                    link.setAttribute('aria-disabled', 'true');
                    link.href = 'javascript:void(0)';
                }
                link.textContent = info.name;
                gameEl.appendChild(link);

                const hoursEl = document.createElement('span');
                hoursEl.className = 'stats-list__hours';
                hoursEl.textContent = `${numberFormatter.format(info.hours)} h`;

                row.append(genreEl, gameEl, hoursEl);
                els.topList.appendChild(row);
            });
        }

        function createEmptyState(label) {
            const note = document.createElement('p');
            note.className = 'stats-empty';
            note.textContent = `No ${label} yet come back after logging more games.`;
            return note;
        }

        async function loadStats() {
            try {
                const response = await fetch('{{ get_url(path="completions.json") | safe }}', { cache: 'no-cache' });
                if (!response.ok) {
                    throw new Error(`Failed to load stats (${response.status})`);
                }
                const payload = await response.json();
                const completions = Array.isArray(payload) ? payload : [];

                const gamesByYearMonth = {};
                const platformCounts = {};
                const genreHoursCounts = {};
                const genreCounts = {};
                const topGamesByGenre = {};
                const recentCompletions = [];
                let totalHours = 0;

                completions.forEach((entry) => {
                    const completionInfo = entry?.completion;
                    const gameInfo = entry?.game;
                    if (!completionInfo || !gameInfo) {
                        return;
                    }
                    const date = new Date(completionInfo.completed_at);
                    if (Number.isNaN(date.getTime())) {
                        return;
                    }
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const hoursPlayed = Number(completionInfo.hours_played) || 0;
                    const gameName = gameInfo.name || 'Unknown game';

                    gamesByYearMonth[year] = gamesByYearMonth[year] || {};
                    gamesByYearMonth[year][month] = gamesByYearMonth[year][month] || [];
                    gamesByYearMonth[year][month].push({ name: gameName, hours: hoursPlayed });
                    const gamePermalink = gameInfo.slug ? `${gamesBaseUrl}${gameInfo.slug}/` : null;
                    recentCompletions.push({
                        name: gameName,
                        slug: gameInfo.slug,
                        completedAt: date,
                        displayDate: date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
                        permalink: gamePermalink
                    });

                    (completionInfo.played_platforms || []).forEach((platform) => {
                        const name = platform?.name || 'Unknown platform';
                        platformCounts[name] = (platformCounts[name] || 0) + 1;
                    });

                    (gameInfo.genres || []).forEach((genre) => {
                        const genreName = genre?.name || 'Unknown';
                        if (!topGamesByGenre[genreName] || hoursPlayed > topGamesByGenre[genreName].hours) {
                            topGamesByGenre[genreName] = { name: gameName, hours: hoursPlayed, permalink: gamePermalink };
                        }
                        genreCounts[genreName] = (genreCounts[genreName] || 0) + 1;
                        genreHoursCounts[genreName] = (genreHoursCounts[genreName] || 0) + hoursPlayed;
                    });

                    totalHours += hoursPlayed;
                });

                const latestThree = recentCompletions
                    .filter((item) => item.completedAt instanceof Date && !Number.isNaN(item.completedAt.getTime()))
                    .sort((a, b) => b.completedAt - a.completedAt)
                    .slice(0, 3);

                renderRecentCompletions(latestThree);
                updateTotals(totalHours, completions.length);
                renderYearTabs(gamesByYearMonth);
                renderPlatformHistogram(platformCounts);
                renderGenreComparison(genreCounts, genreHoursCounts);
                renderTopGames(topGamesByGenre);
            } catch (error) {
                console.error(error);
                els.monthDetail.textContent = 'Unable to load statistics right now.';
                if (els.total) {
                    els.total.textContent = '';
                    els.totalCaption.textContent = error.message;
                }
            }
        }

        loadStats();
    });
</script>
{%- endblock -%}
